!> @brief Método Runge-kutta-Fehlberg-7°-ordem

!Tabela de Butcher referente ao respectivo método
 !________________________________________________
 ! c1=(0.0)    |
 ! c2=(2.0/27) | a21=(2.0/27)
 ! c3=(1.0/9)  | a31=(1.0/36)        a32=(1.0/12)
 ! c4=(1.0/6)  | a41=(1.0/24)        a42=(0.0)   a43=(1.0/8)
 ! c5=(5.0/12) | a51=(5.0/12)        a52=(0.0)   a53=(-25.0/16) a54=(25.0/16)
 ! c6=(1.0/2)  | a61=(1.0/20)        a62=(0.0)   a63=(0.0)      a64=(1.0/4)       a65=(1.0/5)
 ! c7=(5.0/6)  | a71=(-25.0/108)     a72=(0.0)   a73=(0.0)      a74=(125.0/108)   a75=(-65.0/27)     a76=(125.0/54)
 ! c8=(1.0/6)  | a81=(31.0/300)      a82=(0.0)   a83=(0.0)      a84=(0.0)         a85=(61.0/225)     a86=(-2.0/9)     a87=(13.0/900)
 ! c9=(2.0/3)  | a91=(2.0)           a92=(0.0)   a93=(0.0)      a94=(-53.0/6)     a95=(704.0/45)     a96=(-107.0/9)   a97=(67.0/90)      a98=(3.0)
 !c10=(1.0/3)  |a101=(-91.0/108)    a102=(0.0)  a103=(0.0)     a104=(23.0/108)   a105=(-976.0/135)  a106=(311.0/54)  a107=(-19.0/60)    a108=(17.0/6)  a109=(-1.0/12)
 !c11=(1.0)    |a111=(2383.0/4100)  a112=(0.0)  a113=(0.0)     a114=(-341.0/164) a115=(4496.0/1025) a116=(-301.0/82) a117=(2133.0/4100) a118=(45.0/82) a119=(45.0/164) a1110=(18.0/41)
 !c12=(0.0)    |a121=(3.0/205)      a122=(0.0)  a123=(0.0)     a124=(0.0)        a125=(0.0)         a126=(-6.0/41)   a127=(-3.0/205)    a128=(-3.0/41) a129=(3.0/41)   a1210=(6.0/41)  a1211=(0.0)
 !c13=(1.0)    |a131=(-1777.0/4100) a132=(0.0)  a133=(0.0)     a134=(-341.0/164) a135=(4496.0/1025) a136=(-289.0/82) a137=(2193.0/4100) a138=(51.0/82) a139=(33.0/164) a1310=(12.0/41) a1311=(0.0)     a1312=(1.0)            
 !             |-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 !             | b1=(41.0/840)        b2=(0.0)  b3=(0.0)         b4=(0.0)          b5=(0.0)           b6=(34.0/105)    b7=(9.0/35)        b8=(9.0/35)    b9=(9.0/280)    b10=(9.0/280)   b11=(41.0/840)                                                         
 !             | d1=(0.0)             d2=(0.0)  d3=(0.0)         d4=(0.0)          d5=(0.0)           d6=(34.0/105)    d7=(9.0/35)        d8=(9.0/35)    d9=(9.0/280)    d10=(9.0/280)   d11=(0.0)         d12=(41.0/840)  d13=(41.0/840)
 !             |-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 !             | e1=(-41.0/840)       e2=(0.0)  e3=(0.0)         e4=(0.0)          e5=(0.0)           e6=(0.0)         e7=(0.0)           e8=(0.0)       e9=(0.0)        e10=(0.0)       e11=(-41.0/840)   e12=(41.0/840)  e13=(41.0/840)    
 !________________________________________________

!==========================================================
module fehlberg7

    implicit none

    private
    public :: rkfb7_fx, rkfb7_fcx

    real, parameter :: c1=(0.0), c2=(2.0/27), c3=(1.0/9), c4=(1.0/6), c5=(5.0/12), c6=(1.0/2), &
                       c7=(5.0/6), c8=(1.0/6), c9=(2.0/3), c10=(1.0/3), c11=(1.0), c12=(0.0), c13=(1.0)

    real, parameter :: a21=(2.0/27), a31=(1.0/36), a32=(1.0/12), a41=(1.0/24), a42=(0.0), a43=(1.0/8), &
                       a51=(5.0/12), a52=(0.0), a53=(-25.0/16), a54=(25.0/16), a61=(1.0/20), &
                       a62=(0.0), a63=(0.0), a64=(1.0/4), a65=(1.0/5), a71=(-25.0/108), a72=(0.0), &
                       a73=(0.0), a74=(125.0/108), a75=(-65.0/27), a76=(125.0/54), a81=(31.0/300), &
                       a82=(0.0), a83=(0.0), a84=(0.0), a85=(61.0/225), a86=(-2.0/9), a87=(13.0/900), &
                       a91=(2.0), a92=(0.0), a93=(0.0), a94=(-53.0/6), a95=(704.0/45), a96=(-107.0/9), &
                       a97=(67.0/90), a98=(3.0), a101=(-91.0/108), a102=(0.0), a103=(0.0), &
                       a104=(23.0/108), a105=(-976.0/135), a106=(311.0/54), a107=(-19.0/60), &
                       a108=(17.0/6), a109=(-1.0/12), a111=(2383.0/4100), a112=(0.0), a113=(0.0), &
                       a114=(-341.0/164), a115=(4496.0/1025), a116=(-301.0/82), a117=(2133.0/4100), &
                       a118=(45.0/82), a119=(45.0/164), a1110=(18.0/41), a121=(3.0/205), a122=(0.0), &
                       a123=(0.0), a124=(0.0), a125=(0.0), a126=(-6.0/41), a127=(-3.0/205), &
                       a128=(-3.0/41), a129=(3.0/41), a1210=(6.0/41), a1211=(0.0), &
                       a131=(-1777.0/4100), a132=(0.0), a133=(0.0), a134=(-341.0/164), &
                       a135=(4496.0/1025), a136=(-289.0/82), a137=(2193.0/4100), a138=(51.0/82), &
                       a139=(33.0/164), a1310=(12.0/41), a1311=(0.0), a1312=(1.0)

    real, parameter :: b1=(41.0/840), b2=(0.0), b3=(0.0), b4=(0.0), b5=(0.0), b6=(34.0/105), &
                       b7=(9.0/35), b8=(9.0/35), b9=(9.0/280), b10=(9.0/280), b11=(41.0/840)

    real, parameter :: d1=(0.0), d2=(0.0), d3=(0.0), d4=(0.0), d5=(0.0), d6=(34.0/105), d7=(9.0/35), &
                       d8=(9.0/35), d9=(9.0/280), d10=(9.0/280), d11=(0.0), d12=(41.0/840), &
                       d13=(41.0/840)

    real, parameter :: e1=(-41.0/840), e2=(0.0), e3=(0.0), e4=(0.0), e5=(0.0), e6=(0.0), e7=(0.0), &
                       e8=(0.0), e9=(0.0), e10=(0.0), e11=(-41.0/840), e12=(41.0/840), e13=(41.0/840)
    
contains

    subroutine rkfb7_fx(f, x, y0, h, tol, y, err, hopt)

        interface
            pure function f(x) result(y)
                real, dimension(:,:), intent(in) :: x
                real, dimension(size(x,dim=1), size(x,dim=2)) :: y
            end function f
        end interface

        real, dimension(:,:), intent(in) :: x
        real, dimension(:,:), intent(in) :: y0
        real, intent(in) :: h
        real, intent(in) :: tol
        real, dimension(:,:), intent(out) :: y
        real, intent(out) :: hopt
        real, intent(out) :: err
        real, dimension(size(y,dim=1), size(y,dim=2), 13) :: k               
        real, dimension(size(y,dim=1), size(y,dim=2)) :: esti_err_y 
        real :: s

            k(:,:,1) = h*f(x)
            k(:,:,2) = h*f(x + a21*k(:,:,1)) 
            k(:,:,3) = h*f(x + a31*k(:,:,1) + a32*k(:,:,2)) 
            k(:,:,4) = h*f(x + a41*k(:,:,1) + a43*k(:,:,3))                                                          !a42=0.0
            k(:,:,5) = h*f(x + a51*k(:,:,1) + a53*k(:,:,3) + a54*k(:,:,4))                                           !a52=0.0
            k(:,:,6) = h*f(x + a61*k(:,:,1) + a64*k(:,:,4) + a65*k(:,:,5))                                           !a62=0.0, a63=0.0
            k(:,:,7) = h*f(x + a71*k(:,:,1) + a74*k(:,:,4) + a75*k(:,:,5) + a76*k(:,:,6))                            !a72=0.0, a73=0.0
            k(:,:,8) = h*f(x + a81*k(:,:,1) + a85*k(:,:,5) + a86*k(:,:,6) + a87*k(:,:,7))                            !a82=0.0, a83=0.0, a84=0.0
            k(:,:,9) = h*f(x + a91*k(:,:,1) + a94*k(:,:,4) + a95*k(:,:,5) + a96*k(:,:,6) + a97*k(:,:,7) + &
                       a98*k(:,:,8))                                                                                 !a92=0.0, a93=0.0
            k(:,:,10) = h*f(x + a101*k(:,:,1) + a104*k(:,:,4) + a105*k(:,:,5) + a106*k(:,:,6) + a107*k(:,:,7) + & 
                        a108*k(:,:,8) + a109*k(:,:,9))                                                               !a102=0, a103=0
            k(:,:,11) = h*f(x + a111*k(:,:,1) + a114*k(:,:,4) + a115*k(:,:,5) + a116*k(:,:,6) + a117*k(:,:,7) + & 
                        a118*k(:,:,8) + a119*k(:,:,9) + a1110*k(:,:,10))                                             !a112=0.0, a113=0.0 
            k(:,:,12) = h*f(x + a121*k(:,:,1) + a126*k(:,:,6) + a127*k(:,:,7) + a128*k(:,:,8) + a129*k(:,:,9) + &
                        a1210*k(:,:,10))                                                                             !a122=0, a123=0, a124=0, a125=0, a1211=0
            k(:,:,13) = h*f(x + a131*k(:,:,1) + a134*k(:,:,4) + a135*k(:,:,5) + a136*k(:,:,6) + a137*k(:,:,7) + &
                        a138*k(:,:,8) + a139*k(:,:,9) + a1310*k(:,:,10) + a1312*k(:,:,12))                           !a132=0, a133=0, a1311=0   


            y = y0 + b1*k(:,:,1) + b6*k(:,:,6) + b7*k(:,:,7) + b8*k(:,:,8) + b9*k(:,:,9) + b10*k(:,:,10) + &
                b11*k(:,:,11)                                                                                       !b2=0.0, b3=0.0, b4=0.0, b5=0.0  

            esti_err_y = e1*k(:,:,1) + e11*k(:,:,11) + e12*k(:,:,12) + e13*k(:,:,13)                                !e2=0.0, e3=0.0, e4=0.0, e5=0.0, e6=0.0, e7=0.0, e8=0.0, e9=0.0, e10=0.0

            err = maxval(abs(esti_err_y))
            s = ((tol*h)/(2.0*err))**(1.0/7)
            hopt = s*h

    end subroutine rkfb7_fx


    subroutine rkfb7_fcx(f, c, x, y0, h, tol, y, err, hopt)

        interface
            pure function f(c, x) result(y)
                real, dimension(:), intent(in) :: c
                real, dimension(:,:), intent(in) :: x
                real, dimension(size(x,dim=1), size(x,dim=2)) :: y
            end function f
        end interface

        real, dimension(:), intent(in) :: c
        real, dimension(:,:), intent(in) :: x
        real, dimension(:,:), intent(in) :: y0
        real, intent(in) :: h
        real, intent(in) :: tol
        real, dimension(:,:), intent(out) :: y
        real, intent(out) :: hopt
        real, intent(out) :: err
        real, dimension(size(y,dim=1), size(y,dim=2), 13) :: k               
        real, dimension(size(y,dim=1), size(y,dim=2)) :: esti_err_y 
        real :: s

            k(:,:,1) = h*f(c, x)
            k(:,:,2) = h*f(c, x + a21*k(:,:,1)) 
            k(:,:,3) = h*f(c, x + a31*k(:,:,1) + a32*k(:,:,2)) 
            k(:,:,4) = h*f(c, x + a41*k(:,:,1) + a43*k(:,:,3))                                                          !a42=0.0
            k(:,:,5) = h*f(c, x + a51*k(:,:,1) + a53*k(:,:,3) + a54*k(:,:,4))                                           !a52=0.0
            k(:,:,6) = h*f(c, x + a61*k(:,:,1) + a64*k(:,:,4) + a65*k(:,:,5))                                           !a62=0.0, a63=0.0
            k(:,:,7) = h*f(c, x + a71*k(:,:,1) + a74*k(:,:,4) + a75*k(:,:,5) + a76*k(:,:,6))                            !a72=0.0, a73=0.0
            k(:,:,8) = h*f(c, x + a81*k(:,:,1) + a85*k(:,:,5) + a86*k(:,:,6) + a87*k(:,:,7))                            !a82=0.0, a83=0.0, a84=0.0
            k(:,:,9) = h*f(c, x + a91*k(:,:,1) + a94*k(:,:,4) + a95*k(:,:,5) + a96*k(:,:,6) + a97*k(:,:,7) + &
                       a98*k(:,:,8))                                                                                    !a92=0.0, a93=0.0
            k(:,:,10) = h*f(c, x + a101*k(:,:,1) + a104*k(:,:,4) + a105*k(:,:,5) + a106*k(:,:,6) + a107*k(:,:,7) + & 
                        a108*k(:,:,8) + a109*k(:,:,9))                                                                  !a102=0, a103=0
            k(:,:,11) = h*f(c, x + a111*k(:,:,1) + a114*k(:,:,4) + a115*k(:,:,5) + a116*k(:,:,6) + a117*k(:,:,7) + & 
                        a118*k(:,:,8) + a119*k(:,:,9) + a1110*k(:,:,10))                                                !a112=0.0, a113=0.0 
            k(:,:,12) = h*f(c, x + a121*k(:,:,1) + a126*k(:,:,6) + a127*k(:,:,7) + a128*k(:,:,8) + a129*k(:,:,9) + &
                        a1210*k(:,:,10))                                                                                !a122=0, a123=0, a124=0, a125=0, a1211=0
            k(:,:,13) = h*f(c, x + a131*k(:,:,1) + a134*k(:,:,4) + a135*k(:,:,5) + a136*k(:,:,6) + a137*k(:,:,7) + &
                        a138*k(:,:,8) + a139*k(:,:,9) + a1310*k(:,:,10) + a1312*k(:,:,12))                              !a132=0, a133=0, a1311=0   

            y = y0 + b1*k(:,:,1) + b6*k(:,:,6) + b7*k(:,:,7) + b8*k(:,:,8) + b9*k(:,:,9) + b10*k(:,:,10) + &
            & b11*k(:,:,11)                                                                                     !b2=0.0, b3=0.0, b4=0.0, b5=0.0  

            esti_err_y = e1*k(:,:,1) + e11*k(:,:,11) + e12*k(:,:,12) + e13*k(:,:,13)                                    !e2=0.0, e3=0.0, e4=0.0, e5=0.0, e6=0.0, e7=0.0, e8=0.0, e9=0.0, e10=0.0

            err = maxval(abs(esti_err_y))
            s = ((tol*h)/(2.0*err))**(1.0/7)
            hopt = s*h

    end subroutine rkfb7_fcx
    
end module fehlberg7
!==========================================================